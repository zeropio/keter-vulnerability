import { Request, Response, Router } from "express";
import { db } from "../database/database";
import { Log } from "../model/login";

class DatoRoutes {
  private _router: Router;

  constructor() {
    this._router = Router();
  }
  get router() {
    return this._router;
  }

  private index = async (req: Request, res: Response) => {
    res.send("Test API");
  };

  private getUsers = async (req: Request, res: Response) => {
    await db
      .connectionBD()
      .then(async (message) => {
        const query = await Log.find();
        res.json(query);
      })
      .catch((message) => {
        res.send(message);
      });
    db.disconnectionBD();
  };

  private getUser = async (req: Request, res: Response) => {
    await db
      .connectionBD()
      .then(async (message) => {
        const id = req.params.id;
        const query = await Log.find({ _id: { $eq: id } });
        res.json(query);
      })
      .catch((message) => {
        res.send(message);
      });
    db.disconnectionBD();
  };

  private logIn = async (req: Request, res: Response) => {
    await db
      .connectionBD()
      .then(async (mensaje) => {
        const { username, password } = req.body;
        const query = await Log.aggregate([
          {
            $match: { $and: [{ username: username }, { password: password }] },
          },
        ]);
        if (query.length == 0) {
          res.json("Failed login");
        } else {
          res.json(query);
        }
      })
      .catch((mensaje) => {
        res.send(mensaje);
      });
    await db.disconnectionBD();
  };

  private getPass = async (req: Request, res: Response) => {
    await db
      .connectionBD()
      .then(async (mensaje) => {
        const user = req.params.user;
        const query = await Log.aggregate([{ $match: { username: user } }]);
        res.json(query);
      })
      .catch((mensaje) => {
        res.send(mensaje);
      });

    await db.disconnectionBD();
  };

  myRoutes() {
    this._router.get("/", this.index);
    this._router.get("/users", this.getUsers);
    this._router.get("/user/:id", this.getUser);
    this._router.get("/getpass/:user", this.getPass);
    this._router.post("/login", this.logIn);
  }
}

const obj = new DatoRoutes();
obj.myRoutes();
export const routes = obj.router;
